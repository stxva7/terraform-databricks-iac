trigger:
  branches:
    include:
      - dev
      - main

pool:
  name: Default
  demands:
    - agent.name -equals local-agent

variables:
  TF_VERSION: '1.5.7'
  ENVIRONMENT: 'dev'

stages:
  - stage: Terraform_Deploy
    displayName: 'Terraform Deployment'
    jobs:
      - job: Terraform
        displayName: 'Terraform IaC on Windows Agent'
        steps:
          - checkout: self

          - task: PowerShell@2
            displayName: 'Install Terraform CLI'
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "Installing Terraform v$(TF_VERSION)..."
                $tfPath = "C:\terraform"
                if (!(Test-Path $tfPath)) { New-Item -Path $tfPath -ItemType Directory | Out-Null }
                $zip = "$tfPath\terraform.zip"
                Invoke-WebRequest -Uri "https://releases.hashicorp.com/terraform/$(TF_VERSION)/terraform_$(TF_VERSION)_windows_amd64.zip" -OutFile $zip
                Expand-Archive -Path $zip -DestinationPath $tfPath -Force
                [System.Environment]::SetEnvironmentVariable('PATH', $env:PATH + ";$tfPath", [EnvironmentVariableTarget]::Process)
                terraform -version

          - task: PowerShell@2
            displayName: 'Set Azure Auth Environment Variables (from pipeline variables)'
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "Exporting Azure Service Principal credentials..."
                $missing = @()

                if ("$(ARM_CLIENT_ID)" -eq "") { $missing += "ARM_CLIENT_ID" } 
                if ("$(ARM_CLIENT_SECRET)" -eq "") { $missing += "ARM_CLIENT_SECRET" } 
                if ("$(ARM_SUBSCRIPTION_ID)" -eq "") { $missing += "ARM_SUBSCRIPTION_ID" } 
                if ("$(ARM_TENANT_ID)" -eq "") { $missing += "ARM_TENANT_ID" } 

                if ($missing.Count -gt 0) {
                  Write-Error "Missing required pipeline variables: $($missing -join ', '). Add them in Pipeline -> Edit -> Variables or in a Library variable group. Aborting."
                  exit 1
                }

                # Set process-level env vars so Terraform can use them
                [System.Environment]::SetEnvironmentVariable("ARM_CLIENT_ID", "$(ARM_CLIENT_ID)", "Process")
                [System.Environment]::SetEnvironmentVariable("ARM_CLIENT_SECRET", "$(ARM_CLIENT_SECRET)", "Process")
                [System.Environment]::SetEnvironmentVariable("ARM_SUBSCRIPTION_ID", "$(ARM_SUBSCRIPTION_ID)", "Process")
                [System.Environment]::SetEnvironmentVariable("ARM_TENANT_ID", "$(ARM_TENANT_ID)", "Process")
                Write-Host "Environment variables set successfully."

          - task: PowerShell@2
            displayName: 'Sanity check ARM environment'
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "ARM_CLIENT_ID present?  + $([bool]$env:ARM_CLIENT_ID)"
                Write-Host "ARM_SUBSCRIPTION_ID present?  + $([bool]$env:ARM_SUBSCRIPTION_ID)"
                Write-Host "ARM_TENANT_ID present?  + $([bool]$env:ARM_TENANT_ID)"
                if ($env:ARM_TENANT_ID) {
                  Write-Host ("Tenant ID: {0}****** (hidden)" -f $env:ARM_TENANT_ID.Substring(0,8))
                }

          - task: PowerShell@2
            displayName: 'Terraform Init'
            inputs:
              targetType: 'inline'
              script: |
                cd "$(System.DefaultWorkingDirectory)\terraform"
                terraform init -input=false

          - task: PowerShell@2
            displayName: 'Terraform Validate'
            inputs:
              targetType: 'inline'
              script: |
                cd "$(System.DefaultWorkingDirectory)\terraform"
                terraform validate

          - task: PowerShell@2
            displayName: 'Terraform Plan'
            inputs:
              targetType: 'inline'
              script: |
                cd "$(System.DefaultWorkingDirectory)\terraform"
                terraform plan -out=tfplan

          - task: PowerShell@2
            displayName: 'Terraform Apply'
            inputs:
              targetType: 'inline'
              script: |
                cd "$(System.DefaultWorkingDirectory)\terraform"
                terraform apply -auto-approve tfplan
