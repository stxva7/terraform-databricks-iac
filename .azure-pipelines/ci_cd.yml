trigger:
  branches:
    include:
      - main
      - dev

pool:
  name: 'Default'
  demands:
  - agent.name -equals local-agent

variables:
  TF_WORKING_DIR: 'terraform'

stages:
  - stage: Deploy_DEV
    displayName: "Deploy Databricks Infrastructure - DEV"
    condition: eq(variables['Build.SourceBranchName'], 'dev')
    jobs:
      - job: Terraform_DEV
        displayName: "Terraform Apply - DEV"
        steps:
          - checkout: self

          - task: Bash@3
            displayName: "Install Terraform"
            inputs:
              targetType: 'inline'
              script: |
                sudo apt-get update -y
                sudo apt-get install -y unzip wget
                wget https://releases.hashicorp.com/terraform/1.9.0/terraform_1.9.0_linux_amd64.zip
                unzip terraform_1.9.0_linux_amd64.zip
                sudo mv terraform /usr/local/bin/
                terraform -version

          - task: Bash@3
            displayName: "Terraform Init"
            inputs:
              workingDirectory: '$(TF_WORKING_DIR)'
              targetType: 'inline'
              script: |
                terraform init

          - task: Bash@3
            displayName: "Terraform Plan"
            inputs:
              workingDirectory: '$(TF_WORKING_DIR)'
              targetType: 'inline'
              script: |
                terraform plan -out=tfplan

          - task: Bash@3
            displayName: "Terraform Apply"
            inputs:
              workingDirectory: '$(TF_WORKING_DIR)'
              targetType: 'inline'
              script: |
                terraform apply -auto-approve tfplan

  - stage: Deploy_PROD
    displayName: "Deploy Databricks Infrastructure - PROD"
    condition: eq(variables['Build.SourceBranchName'], 'main')
    jobs:
      - job: Terraform_PROD
        displayName: "Terraform Apply - PROD"
        steps:
          - checkout: self

          - task: Bash@3
            displayName: "Install Terraform"
            inputs:
              targetType: 'inline'
              script: |
                sudo apt-get update -y
                sudo apt-get install -y unzip wget
                wget https://releases.hashicorp.com/terraform/1.9.0/terraform_1.9.0_linux_amd64.zip
                unzip terraform_1.9.0_linux_amd64.zip
                sudo mv terraform /usr/local/bin/
                terraform -version

          - task: Bash@3
            displayName: "Terraform Init"
            inputs:
              workingDirectory: '$(TF_WORKING_DIR)'
              targetType: 'inline'
              script: |
                terraform init

          - task: Bash@3
            displayName: "Terraform Plan"
            inputs:
              workingDirectory: '$(TF_WORKING_DIR)'
              targetType: 'inline'
              script: |
                terraform plan -out=tfplan

          - task: Bash@3
            displayName: "Terraform Apply"
            inputs:
              workingDirectory: '$(TF_WORKING_DIR)'
              targetType: 'inline'
              script: |
                terraform apply -auto-approve tfplan
