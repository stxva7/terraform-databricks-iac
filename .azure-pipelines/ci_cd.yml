trigger:
  branches:
    include:
      - dev
      - main

pool:
  name: Default
  demands:
    - agent.name -equals local-agent

variables:
  TF_VERSION: '1.5.7'
  ENVIRONMENT: 'dev'

stages:
  - stage: Terraform_Deploy
    displayName: 'Terraform Deployment'
    jobs:
      - job: Terraform
        displayName: 'Terraform IaC on Windows Agent'
        steps:
          # Step 1: Check out repository
          - checkout: self

          # Step 2: Install Terraform (Windows)
          - task: PowerShell@2
            displayName: 'Install Terraform CLI'
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "Installing Terraform v$(TF_VERSION)..."
                $tfPath = "C:\terraform"
                if (!(Test-Path $tfPath)) { New-Item -Path $tfPath -ItemType Directory | Out-Null }
                Invoke-WebRequest -Uri "https://releases.hashicorp.com/terraform/$(TF_VERSION)/terraform_$(TF_VERSION)_windows_amd64.zip" -OutFile "$tfPath\terraform.zip"
                Expand-Archive -Path "$tfPath\terraform.zip" -DestinationPath $tfPath -Force
                [Environment]::SetEnvironmentVariable('PATH', $env:PATH + ";$tfPath", [EnvironmentVariableTarget]::Process)
                terraform -version

          # Step 3: Terraform Init (includes SP authentication)
          - task: PowerShell@2
            displayName: 'Terraform Init'
            inputs:
              targetType: 'inline'
              script: |
                cd "$(System.DefaultWorkingDirectory)\terraform"

                # --- Azure Service Principal Authentication ---
                $env:ARM_CLIENT_ID = "$(ARM_CLIENT_ID)"
                $env:ARM_CLIENT_SECRET = "$(ARM_CLIENT_SECRET)"
                $env:ARM_SUBSCRIPTION_ID = "$(ARM_SUBSCRIPTION_ID)"
                $env:ARM_TENANT_ID = "$(ARM_TENANT_ID)"

                Write-Host "Authenticating Terraform backend with Service Principal..."
                terraform init -input=false -no-color

          # Step 4: Terraform Validate
          - task: PowerShell@2
            displayName: 'Terraform Validate'
            inputs:
              targetType: 'inline'
              script: |
                cd "$(System.DefaultWorkingDirectory)\terraform"
                terraform validate -no-color

          # Step 5: Terraform Plan
          - task: PowerShell@2
            displayName: 'Terraform Plan'
            inputs:
              targetType: 'inline'
              script: |
                cd "$(System.DefaultWorkingDirectory)\terraform"

                # Re-export vars for each isolated step
                $env:ARM_CLIENT_ID = "$(ARM_CLIENT_ID)"
                $env:ARM_CLIENT_SECRET = "$(ARM_CLIENT_SECRET)"
                $env:ARM_SUBSCRIPTION_ID = "$(ARM_SUBSCRIPTION_ID)"
                $env:ARM_TENANT_ID = "$(ARM_TENANT_ID)"

                terraform plan -out=tfplan -input=false -no-color

          # Step 6: Terraform Apply (auto-approve)
          - task: PowerShell@2
            displayName: 'Terraform Apply'
            inputs:
              targetType: 'inline'
              script: |
                cd "$(System.DefaultWorkingDirectory)\terraform"

                # Re-export vars for consistency
                $env:ARM_CLIENT_ID = "$(ARM_CLIENT_ID)"
                $env:ARM_CLIENT_SECRET = "$(ARM_CLIENT_SECRET)"
                $env:ARM_SUBSCRIPTION_ID = "$(ARM_SUBSCRIPTION_ID)"
                $env:ARM_TENANT_ID = "$(ARM_TENANT_ID)"

                terraform apply -auto-approve tfplan -no-color
